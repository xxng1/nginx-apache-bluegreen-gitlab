worker_processes auto;
events { worker_connections 1024; }
http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;

  upstream app_blue  { server app-blue:80;  keepalive 64; }
  upstream app_green { server app-green:80; keepalive 64; }

  # 활성 업스트림은 아래 conf.d의 파일을 include (심볼릭 링크로 전환)
  include /etc/nginx/conf.d/app_active.conf;

  server {
    listen 8081;

    location / {
      proxy_pass http://app_active;
      proxy_set_header Host $host;
      proxy_read_timeout 30s;
    }

    # 슬롯 직접 확인
    location /_blue/  { proxy_pass http://app_blue/; }
    location /_green/ { proxy_pass http://app_green/; }

    # edge 자체 헬스
    location /healthz { return 200 "ok"; }
  }
}
